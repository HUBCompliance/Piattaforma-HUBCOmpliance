{% extends "base_studente.html" %}
{% load i18n static %}

{% block title %}{% translate "Riepilogo CSIRT (Referente)" %}{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex align-items-center">
            {% if referente_csirt.azienda.logo_principale %}
                <img src="{{ referente_csirt.azienda.logo_principale.url }}" alt="Logo Azienda" class="me-3 border rounded p-1 bg-white shadow-sm" style="max-height: 60px; width: auto;">
            {% endif %}
            <div>
                <h1 class="h3 mb-0">{% translate "Riepilogo Modulo CSIRT (NIS2)" %}</h1>
                <p class="text-muted mb-0">{% translate "Monitoraggio e azioni rapide per" %} <strong>{{ azienda.nome }}</strong>.</p>
            </div>
        </div>
    </div>
</div>

{% include "includes/messages.html" %}

<div class="row g-4">
    
    {# === COLONNA SINISTRA === #}
    <div class="col-lg-6">
        
        {# CARD 1: DATI REFERENTE (COLLASSABILE - CHIUSA DI DEFAULT) #}
        <div class="card shadow-sm mb-4 border-danger border-3 border-start">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <button class="btn btn-link text-white text-decoration-none p-0 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDatiReferente" aria-expanded="false" aria-controls="collapseDatiReferente">
                        <i class="bi bi-chevron-right me-2"></i> {% translate "Dati Referente Designato" %}
                    </button>
                </h5>
            </div>
            <div id="collapseDatiReferente" class="collapse">
                <div class="card-body">
                    <dl class="row small">
                        <dt class="col-sm-6 fw-bold">{% translate "Referente Designato" %}:</dt>
                        <dd class="col-sm-6">{{ referente_csirt.ref_nome }} {{ referente_csirt.ref_cognome }}</dd>
                        
                        <dt class="col-sm-6 fw-bold">{% translate "Ruolo Aziendale" %}:</dt>
                        <dd class="col-sm-6">{{ referente_csirt.ref_ruolo|default:"Non definito" }}</dd>
                        
                        <dt class="col-sm-6 fw-bold">{% translate "Email Reperibilità" %}:</dt>
                        <dd class="col-sm-6">{{ referente_csirt.ref_email }}</dd>
                        
                        <dt class="col-sm-6 fw-bold">{% translate "Telefono H24" %}:</dt>
                        <dd class="col-sm-6">{{ referente_csirt.ref_telefono|default:"N/A" }}</dd>

                        <dt class="col-sm-6 fw-bold">{% translate "Nomina Documentata" %}:</dt>
                        <dd class="col-sm-6">
                            {% if referente_csirt.competenze_documentate %}
                                <span class="badge bg-success">{% translate "Sì" %}</span>
                            {% else %}
                                <span class="badge bg-warning">{% translate "No/In attesa" %}</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        {# AZIONI IMMEDIATE (Sempre visibili perché critiche) #}
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h6 class="small fw-bold mb-3"><i class="bi bi-lightning-charge-fill text-danger"></i> {% translate "Azioni Immediate" %}</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'compliance:csirt_notifica_create' %}" class="btn btn-danger">
                        <i class="bi bi-plus-circle me-1"></i> {% translate "Registra Nuova Notifica Incidente" %}
                    </a>
                    <a href="{% url 'compliance:configurazione_rete_view' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-diagram-3 me-1"></i> {% translate "Visualizza Configurazione Rete" %}
                    </a>
                </div>
            </div>
        </div>

        {# LISTA CONTATTI INTERNI #}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">{% translate "Lista CONTATTI INTERNI" %}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">{% translate "Contatti interni utili per la gestione degli incidenti." %}</p>
                {% if contatti_interni %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>{% translate "Nominativo" %}</th>
                                    <th>{% translate "Ruolo" %}</th>
                                    <th>{% translate "Telefono Ufficio" %}</th>
                                    <th>{% translate "Mobile" %}</th>
                                    <th>{% translate "Email" %}</th>
                                    <th>{% translate "Tipo Disponibilità" %}</th>
                                    <th>{% translate "Note" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contatto in contatti_interni %}
                                    <tr>
                                        <td class="fw-semibold">{{ contatto.nominativo }}</td>
                                        <td>{{ contatto.ruolo }}</td>
                                        <td>{{ contatto.telefono_ufficio }}</td>
                                        <td>{{ contatto.mobile }}</td>
                                        <td>{{ contatto.email }}</td>
                                        <td>{{ contatto.tipo_disponibilita }}</td>
                                        <td>{{ contatto.note }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted small mb-0">{% translate "Nessun contatto interno registrato." %}</p>
                {% endif %}
            </div>
        </div>
        
        {# CARD 2: TEMPISTICHE NIS2 #}
        <div class="card shadow-sm mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">{% translate "Tempistiche Notifiche (NIS2 Art. 25)" %}</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-sm mb-0">
                    <tbody>
                        <tr>
                            <td class="text-danger fw-bold small" style="width: 25%">{% translate "Entro 24 ore" %}</td>
                            <td class="small">{% translate "Prima notifica (early warning) allo CSIRT." %}</td>
                        </tr>
                        <tr>
                            <td class="text-warning fw-bold small">{% translate "Entro 72 ore" %}</td>
                            <td class="small">{% translate "Aggiornamento e valutazione preliminare." %}</td>
                        </tr>
                        <tr>
                            <td class="text-success fw-bold small">{% translate "Entro 1 mese" %}</td>
                            <td class="small">{% translate "Report conclusivo e azioni correttive." %}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>
    
    {# === COLONNA DESTRA === #}
    <div class="col-lg-6">
        
        {# CARD 3: STATO INCIDENTI E REGISTRO (COLLASSABILE - APERTA DI DEFAULT) #}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-dark">
                    <button class="btn btn-link text-dark text-decoration-none p-0 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStatoIncidenti" aria-expanded="true" aria-controls="collapseStatoIncidenti">
                        <i class="bi bi-chevron-down me-2"></i> {% translate "Stato Incidenti e Registro" %}
                    </button>
                </h5>
            </div>
            <div id="collapseStatoIncidenti" class="collapse show">
                <div class="card-body">
                    <div class="position-relative" style="height:220px;">
                        <canvas id="csirtDoughnut"></canvas>
                    </div>
                    <div class="small text-muted text-center mt-2 mb-4">
                        {% translate "Distribuzione per stato delle notifiche." %}
                    </div>

                    {% if notifiche %}
                        <h6 class="small fw-bold border-bottom pb-2">{% translate "Notifiche Attive" %}</h6>
                        <ul class="list-group list-group-flush small">
                            {% for notifica in notifiche %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">{{ notifica.titolo_incidente }}</h6>
                                        <small class="text-muted">{{ notifica.data_incidente|date:"d M Y H:i" }}</small>
                                    </div>
                                    <a href="{% url 'compliance:csirt_notifica_dettaglio' pk=notifica.pk %}" class="btn btn-sm btn-outline-info">
                                        {% translate "Dettaglio" %}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small text-center py-3">{% translate "Nessuna notifica registrata." %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    
    // Gestione icone dinamiche per i collapse
    const collapses = document.querySelectorAll('.collapse');
    collapses.forEach(el => {
        el.addEventListener('show.bs.collapse', function () {
            const icon = document.querySelector(`[data-bs-target="#${this.id}"] i.bi`);
            if(icon) icon.classList.replace('bi-chevron-right', 'bi-chevron-down');
        });
        el.addEventListener('hide.bs.collapse', function () {
            const icon = document.querySelector(`[data-bs-target="#${this.id}"] i.bi`);
            if(icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
        });
    });

    // ===== GRAFICO CIAMBELLA =====
    const el = document.getElementById("csirtDoughnut");
    if (el && typeof Chart !== "undefined") {
        const raw = "{{ dati_grafico_stati_json|default:'{}'|escapejs }}";
        let dataObj = {};
        try { dataObj = JSON.parse(raw); } catch (e) { console.error(e); }

        const labels = Object.keys(dataObj);
        const values = Object.values(dataObj);
        const hasData = values.reduce((a,b)=>a+b,0) > 0;

        const colorMap = {
            '{% translate "Aperta" %}': '#ffc107', 
            '{% translate "In Risposta/Gestione" %}': '#0d6efd', 
            '{% translate "Notificata ACN" %}': '#28a745', 
            '{% translate "Chiusa" %}': '#6c757d'
        };
        
        const backgroundColors = labels.map(label => colorMap[label] || '#dc3545');

        new Chart(el, {
            type: "doughnut",
            data: {
                labels: hasData ? labels : ["{% translate 'Nessun dato' %}"],
                datasets: [{ 
                    data: hasData ? values : [1],
                    backgroundColor: hasData ? backgroundColors : ['#e0e0e0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: "70%",
                plugins: { legend: { position: "bottom", labels: { boxWidth: 12, font: { size: 11 } } } }
            }
        });
    }
});
</script>
{% endblock content %}

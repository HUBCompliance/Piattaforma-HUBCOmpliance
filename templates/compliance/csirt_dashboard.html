{% extends "base_studente.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Modulo Referente CSIRT (NIS2)" %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                {% if referente_csirt.azienda.logo_principale %}
                    <img src="{{ referente_csirt.azienda.logo_principale.url }}" alt="Logo" class="me-3 border rounded p-1 bg-white shadow-sm" style="max-height: 60px;">
                {% endif %}
                <div>
                    <h1 class="h3 mb-0">{% translate "Modulo Referente CSIRT (NIS2)" %}</h1>
                    <p class="text-muted mb-0">{% translate "Designazione e adempimenti per" %}: <strong>{{ referente_csirt.azienda.nome }}</strong></p>
                </div>
            </div>
            <a href="{% url 'compliance:download_csirt_nomina' %}" class="btn btn-primary shadow-sm">
                <i class="bi bi-file-earmark-pdf me-2"></i>{% translate "Scarica Nomina Ufficiale" %}
            </a>
        </div>
    </div>
</div>

{% include "includes/messages.html" %}

<div class="row">
    {# === COLONNA SINISTRA: DESIGNAZIONE (COLLAPSIBLE) === #}
    <div class="col-lg-7">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header d-flex justify-content-between align-items-center" 
                 style="background-color: #0d6efd !important; min-height: 55px; border-bottom: none;">
                <h5 class="mb-0 flex-grow-1">
                    <button class="btn btn-link text-white text-decoration-none shadow-none w-100 text-start p-0 fw-bold d-flex align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#collapseDesignazione">
                        <i class="bi bi-chevron-right me-2" id="chevron-designazione"></i> 
                        {% translate "1. Designazione Referente e Sostituti" %}
                    </button>
                </h5>
            </div>
            <div id="collapseDesignazione" class="collapse show"> {# Mostrato di default per facilitare l'inserimento #}
                <div class="card-body">
                    <form method="post" id="csirt-form">
                        {% csrf_token %}
                        
                        {# SEZIONE A: REFERENTE #}
                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">{% translate "A. Referente Designato" %}</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6"><label class="small fw-bold">{% translate "Nome" %}</label>{{ form.ref_nome }}</div>
                            <div class="col-md-6"><label class="small fw-bold">{% translate "Cognome" %}</label>{{ form.ref_cognome }}</div>
                            <div class="col-md-6"><label class="small fw-bold">{% translate "Codice Fiscale" %}</label>{{ form.ref_cf }}</div>
                            <div class="col-md-6"><label class="small fw-bold">{% translate "Ruolo" %}</label>{{ form.ref_ruolo }}</div>
                            <div class="col-md-6"><label class="small fw-bold">{% translate "Email" %}</label>{{ form.ref_email }}</div>
                            <div class="col-md-6"><label class="small fw-bold">{% translate "Telefono" %}</label>{{ form.ref_telefono }}</div>
                            <div class="col-md-12"><label class="small fw-bold">{% translate "Data Nomina" %}</label>{{ form.data_nomina }}</div>
                        </div>

                        {# SEZIONE B: PUNTO DI CONTATTO ACN #}
                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">{% translate "B. Punto di Contatto per ACN" %}</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><label class="small fw-bold">{% translate "Nome PdC" %}</label>{{ form.pc_nome }}</div>
                            <div class="col-md-4"><label class="small fw-bold">{% translate "Cognome PdC" %}</label>{{ form.pc_cognome }}</div>
                            <div class="col-md-4"><label class="small fw-bold">{% translate "Email PdC" %}</label>{{ form.pc_email }}</div>
                        </div>

                        {# SEZIONE C: SOSTITUTI #}
                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">{% translate "C. Sostituti Designati" %}</h6>
                        <div class="bg-light p-3 rounded mb-4">
                            <div class="row g-2">
                                <div class="col-md-4"><label class="smaller">{% translate "Nome Sos 1" %}</label>{{ form.sos1_nome }}</div>
                                <div class="col-md-4"><label class="smaller">{% translate "Cognome Sos 1" %}</label>{{ form.sos1_cognome }}</div>
                                <div class="col-md-4"><label class="smaller">{% translate "Email Sos 1" %}</label>{{ form.sos1_email }}</div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-4"><label class="smaller">{% translate "Nome Sos 2" %}</label>{{ form.sos2_nome }}</div>
                                <div class="col-md-4"><label class="smaller">{% translate "Cognome Sos 2" %}</label>{{ form.sos2_cognome }}</div>
                                <div class="col-md-4"><label class="smaller">{% translate "Email Sos 2" %}</label>{{ form.sos2_email }}</div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="submit" class="btn btn-success px-4 shadow-sm">
                                <i class="bi bi-save me-1"></i> {% translate "Salva Designazione" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                <h5 class="mb-0">
                    <button class="btn btn-link text-dark text-decoration-none shadow-none w-100 text-start p-0 fw-bold d-flex align-items-center"
                            type="button" data-bs-toggle="collapse" data-bs-target="#collapseContattiInterni">
                        <i class="bi bi-chevron-right me-2" id="chevron-contatti"></i>
                        {% translate "Lista CONTATTI INTERNI" %}
                    </button>
                </h5>
            </div>
            <div id="collapseContattiInterni" class="collapse show">
                <div class="card-body">
                    <p class="text-muted small mb-3">{% translate "Quest'area √® sempre disponibile al consulente per capire chi bisogna contattare in azienda." %}</p>
                    <form method="post" id="contatti-form" action="{% url 'compliance:csirt_dashboard' %}?azienda_id={{ azienda.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="form_action" value="contatti">
                        {{ contatti_formset.management_form }}
                        {% if contatti_formset.non_form_errors %}
                            <div class="alert alert-danger small">{{ contatti_formset.non_form_errors }}</div>
                        {% endif %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>{% translate "Nominativo" %}</th>
                                        <th>{% translate "Ruolo" %}</th>
                                        <th>{% translate "Telefono Ufficio" %}</th>
                                        <th>{% translate "Mobile" %}</th>
                                        <th>{% translate "Email" %}</th>
                                        <th>{% translate "Tipo Disponibilit√†" %}</th>
                                        <th>{% translate "Note" %}</th>
                                        <th class="text-center">{% translate "Rimuovi" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for contatto_form in contatti_formset %}
                                        <tr>
                                            <td>
                                                {{ contatto_form.id }}
                                                {{ contatto_form.nominativo }}
                                                {% if contatto_form.nominativo.errors %}
                                                    <div class="text-danger small">{{ contatto_form.nominativo.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td>{{ contatto_form.ruolo }}</td>
                                            <td>{{ contatto_form.telefono_ufficio }}</td>
                                            <td>{{ contatto_form.mobile }}</td>
                                            <td>{{ contatto_form.email }}</td>
                                            <td>{{ contatto_form.tipo_disponibilita }}</td>
                                            <td>{{ contatto_form.note }}</td>
                                            <td class="text-center">
                                                {{ contatto_form.DELETE }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-save me-1"></i> {% translate "Salva Contatti" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# --- COLONNA DESTRA: STRUMENTI E NOTIFICHE --- #}
    <div class="col-lg-5">
        
       {# CARD STRUMENTI OPERATIVA #}
{% if request.user.ruolo == 'CONSULENTE' %}
<div class="card shadow-sm mb-4 border-start border-info border-4">
    <div class="card-header bg-light py-2">
        <h6 class="mb-0 fw-bold text-info text-uppercase small">
            <i class="bi bi-tools me-2"></i>{% translate "Strumenti di Compromissione" %}
        </h6>
    </div>
    
    <div class="card-body">
        <div class="row g-2">
            <div class="col-12 p-2 border rounded bg-white shadow-sm mb-2">
                <small class="text-muted d-block mb-2 fw-bold">Verifica Deashed</small>
                <a href="{% url 'courses:avvia_scansione_deashed' azienda.id %}" class="btn btn-outline-primary w-100">
                    <i class="bi bi-play-fill"></i> Scansione
                </a>
            </div>

            <div class="col-12 p-2 border rounded bg-white shadow-sm mb-2">
                <p class="small fw-bold text-secondary mb-2 border-bottom pb-1">{% translate "Pentest-Tools" %} üõ°Ô∏è</p>
                <a href="https://app.pentest-tools.com/dashboard" target="_blank" class="btn btn-xs btn-outline-danger w-100 py-1">
                    <i class="bi bi-shield-shaded me-1"></i> {% translate "Dashboard Analisi" %}
                </a>
            </div>

            <div class="col-12 p-2 border rounded bg-white shadow-sm">
                <p class="small fw-bold text-secondary mb-2 border-bottom pb-1">{% translate "ViewDNS" %} üåê</p>
                <a href="{% url 'courses:analisi_dns_view' azienda.id %}" class="btn btn-xs btn-outline-info w-100 py-1">
                    <i class="bi bi-globe me-1"></i> {% translate "Analisi DNS" %}
                </a>
            </div>
        </div> </div> </div>
{% endif %}

        {# REGISTRO NOTIFICHE (COLLAPSIBLE) #}
        <div class="card shadow-sm border-danger mb-4">
            <div class="card-header bg-danger text-white py-2">
                <h5 class="mb-0 small">
                    <button class="btn btn-link text-white text-decoration-none shadow-none w-100 text-start p-0 fw-bold d-flex align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#collapseRegistro">
                        <i class="bi bi-chevron-right me-2" id="chevron-registro"></i> 
                        {% translate "2. Registro Notifiche Incidente" %}
                    </button>
                </h5>
            </div>
            <div id="collapseRegistro" class="collapse">
                <div class="card-body p-0">
                    <div class="p-3 border-bottom text-center">
                        <a href="{% url 'compliance:csirt_notifica_create' %}" class="btn btn-danger btn-sm w-100 fw-bold">
                            <i class="bi bi-bell-fill me-2"></i>{% translate "Registra Notifica" %}
                        </a>
                    </div>
                    <div class="list-group list-group-flush small" style="max-height: 250px; overflow-y: auto;">
                        {% for notifica in notifiche %}
                            <a href="{% url 'compliance:csirt_notifica_dettaglio' pk=notifica.pk %}?azienda_id={{ azienda.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <span>{{ notifica.titolo_incidente|truncatechars:30 }}</span>
                                <span class="badge bg-secondary">{{ notifica.get_stato_display }}</span>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Applica classi Bootstrap
        document.querySelectorAll('#csirt-form input, #csirt-form select').forEach(el => {
            el.classList.add('form-control', 'form-control-sm');
        });
        document.querySelectorAll('#contatti-form input, #contatti-form select, #contatti-form textarea').forEach(el => {
            if (el.type !== 'checkbox') {
                el.classList.add('form-control', 'form-control-sm');
            } else {
                el.classList.add('form-check-input');
            }
        });

        // Gestione icone chevron
        const setupChevron = (collapseId, chevronId) => {
            const el = document.getElementById(collapseId);
            if(el) {
                el.addEventListener('show.bs.collapse', () => {
                    document.getElementById(chevronId).classList.replace('bi-chevron-right', 'bi-chevron-down');
                });
                el.addEventListener('hide.bs.collapse', () => {
                    document.getElementById(chevronId).classList.replace('bi-chevron-down', 'bi-chevron-right');
                });
            }
        };
        setupChevron('collapseDesignazione', 'chevron-designazione');
        setupChevron('collapseContattiInterni', 'chevron-contatti');
        setupChevron('collapseRegistro', 'chevron-registro');
    });
</script>
{% endblock content %}

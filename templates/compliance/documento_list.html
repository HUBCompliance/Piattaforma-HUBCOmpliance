{% extends 'base_studente.html' %}
{% load i18n %}

{% block title %}{% translate "Gestione Documentale" %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard_compliance' %}">{% translate "Cruscotto Compliance" %}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{% translate "Gestione Documentale" %}</li>
            </ol>
        </nav>

        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% translate "Repository Documenti Aziendali" %}</h5>
                <a href="{% url 'documento_create' %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle me-1"></i> {% translate "Aggiungi Documento" %}
                </a>
            </div>
            <div class="card-body">
                <p>{% translate "Archivio centrale delle tue informative, nomine e policy." %}</p>
                
                {% if not categorie_aziendali %}
                    <p class="text-muted text-center">{% translate "Nessun documento caricato. Clicca 'Aggiungi Documento' per iniziare." %}</p>
                {% endif %}

                {% for categoria in categorie_aziendali %}
                    <h6 class="mt-3">{{ categoria.nome }}</h6>
                    <ul class="list-group">
                        {% for doc in categoria.documentoaziendale_set.all %}
                            {% if doc.azienda == request.user.azienda %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-file-earmark-text-fill me-2"></i>
                                    <a href="{% url 'documento_dettaglio' doc.pk %}">{{ doc.nome }}</a>
                                    {% with versione_corrente=doc.versione_corrente %}
                                        {% if versione_corrente %}
                                            <br><small class="text-muted">{% translate "Versione del" %}: {{ versione_corrente.data_caricamento|date:"d/m/Y" }}</small>
                                        {% else %}
                                            <br><small class="text-danger">({% translate "Nessuna versione caricata" %})</small>
                                        {% endif %}
                                    {% endwith %}
                                </span>
                                <div>
                                    {% if categoria.nome == "Attestati di Formazione" %}
                                        <a href="{% url 'documento_dettaglio' doc.pk %}" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-eye-fill me-1"></i> {% translate "Vedi Dettagli" %}
                                        </a>
                                    {% else %}
                                        <a href="{% url 'versione_create' doc.pk %}" class="btn btn-success btn-sm">
                                            <i class="bi bi-upload me-1"></i> {% translate "Carica Nuova Versione" %}
                                        </a>
                                    {% endif %}
                                    </div>
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endfor %}
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% translate "Template (Modelli)" %}</h5>
            </div>
            <div class="card-body">
                <p>{% translate "Usa questi modelli pre-approvati per creare i tuoi documenti." %}</p>
                <ul class="list-group">
                    {% for template in templates_list %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <i class="bi bi-file-earmark-zip-fill me-2"></i>
                                {{ template.nome }}
                                <br><small class="text-muted">{{ template.categoria.nome }} - {{ template.descrizione }}</small>
                            </span>
                            <a href="{% url 'download_template' template.pk %}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-download me-1"></i> {% translate "Scarica" %}
                            </a>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-center text-muted">{% translate "Nessun template disponibile al momento." %}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>
</div>
{% endblock %}
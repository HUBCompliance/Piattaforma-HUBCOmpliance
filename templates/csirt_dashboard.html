{% extends "base_studente.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Modulo Referente CSIRT (NIS2)" %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex align-items-center">
            {% if referente_csirt.azienda.logo_principale %}
                <img src="{{ referente_csirt.azienda.logo_principale.url }}" alt="Logo Azienda" class="me-3 border rounded p-1 bg-white shadow-sm" style="max-height: 60px; width: auto;">
            {% endif %}
            <div>
                <h1 class="h3 mb-0">{% translate "Modulo Referente CSIRT (NIS2)" %}</h1>
                <p class="text-muted mb-0">{% translate "Designazione e adempimenti per" %}: <strong>{{ referente_csirt.azienda.nome }}</strong></p>
            </div>
        </div>
    </div>
</div>

{% include "includes/messages.html" %}

<div class="row">
    
    {# === COLONNA SINISTRA: DATI REFERENTE === #}
    <div class="col-lg-7">
        
        {# CARD 1: DESIGNAZIONE REFERENTE #}
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center" 
                 style="background-color: #0d6efd !important; min-height: 55px; border-bottom: none;">
                
                <h5 class="mb-0 flex-grow-1">
                    <button class="btn btn-link text-white text-decoration-none shadow-none w-100 text-start p-0 fw-bold d-flex align-items-center" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapseDesignazione" 
                            aria-expanded="false" 
                            aria-controls="collapseDesignazione">
                        <i class="bi bi-chevron-right me-2" id="toggle-icon-1"></i> 
                        {% translate "1. Designazione Referente" %}
                    </button>
                </h5>
                
                <a href="{% url 'compliance:download_csirt_nomina' %}" class="btn btn-sm btn-light text-primary fw-bold shadow-sm">
                    <i class="bi bi-download me-1"></i> {% translate "Scarica Nomina" %}
                </a>
            </div>

            <div id="collapseDesignazione" class="collapse">
                <div class="card-body">
                    <form method="post" id="csirt-form">
                        {% csrf_token %}
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger small mb-3">{{ form.non_field_errors }}</div>
                        {% endif %}
                        
                        <h6 class="mt-2 mb-3 text-primary fw-bold">{% translate "A. Utente Loggato (Sola Lettura)" %}</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold small text-secondary">{% translate "Nome Utente" %}</label>
                                <input type="text" class="form-control bg-light" disabled value="{{ request.user.first_name|default:'N/A' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold small text-secondary">{% translate "Cognome Utente" %}</label>
                                <input type="text" class="form-control bg-light" disabled value="{{ request.user.last_name|default:'N/A' }}">
                            </div>
                        </div>
                        
                        <hr>
                        <h6 class="mt-4 mb-3 text-primary fw-bold">{% translate "B. Dati Referente Designato e Ruolo" %}</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">{{ form.data_nomina.label_tag }}{{ form.data_nomina }}</div>
                            <div class="col-md-6 mb-3">{{ form.ref_ruolo.label_tag }}{{ form.ref_ruolo }}</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">{{ form.ref_nome.label_tag }}{{ form.ref_nome }}</div>
                            <div class="col-md-4 mb-3">{{ form.ref_cognome.label_tag }}{{ form.ref_cognome }}</div>
                            <div class="col-md-4 mb-3">{{ form.ref_cf.label_tag }}{{ form.ref_cf }}</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">{{ form.ref_email.label_tag }}{{ form.ref_email }}</div>
                            <div class="col-md-6 mb-3">{{ form.ref_telefono.label_tag }}{{ form.ref_telefono }}</div>
                        </div>

                        <h6 class="mt-4 mb-3 text-primary fw-bold">{% translate "C. Punto di Contatto ACN" %}</h6>
                        <div class="row">
                            <div class="col-md-4 mb-3">{{ form.pc_nome.label_tag }}{{ form.pc_nome }}</div>
                            <div class="col-md-4 mb-3">{{ form.pc_cognome.label_tag }}{{ form.pc_cognome }}</div>
                            <div class="col-md-4 mb-3">{{ form.pc_email.label_tag }}{{ form.pc_email }}</div>
                        </div>

                        <h6 class="mt-4 mb-3 text-primary fw-bold">{% translate "D. Sostituti" %}</h6>
                        <div class="row border-bottom pb-3 small">
                            <div class="col-md-4">{{ form.sos1_nome.label_tag }}{{ form.sos1_nome }}</div>
                            <div class="col-md-4">{{ form.sos1_cognome.label_tag }}{{ form.sos1_cognome }}</div>
                            <div class="col-md-4">{{ form.sos1_email.label_tag }}{{ form.sos1_email }}</div>
                        </div>
                        <div class="row pt-3 small">
                            <div class="col-md-4">{{ form.sos2_nome.label_tag }}{{ form.sos2_nome }}</div>
                            <div class="col-md-4">{{ form.sos2_cognome.label_tag }}{{ form.sos2_cognome }}</div>
                            <div class="col-md-4">{{ form.sos2_email.label_tag }}{{ form.sos2_email }}</div>
                        </div>

                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary shadow-sm"><i class="bi bi-save me-1"></i> {% translate "Salva Dati" %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        {% if template_form %}
        <div class="card shadow-sm mb-4 border-secondary border-opacity-25">
            <div class="card-header bg-secondary text-white py-2">
                <h6 class="mb-0 small"><i class="bi bi-file-earmark-word me-2"></i>{% translate "Template Nomina" %}</h6>
            </div>
            <div class="card-body bg-light">
                <form action="{% url 'compliance:csirt_upload_template' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="input-group input-group-sm">
                        {{ template_form.template_nomina_csirt }}
                        <button class="btn btn-outline-secondary" type="submit">{% translate "Carica" %}</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    
    {# === COLONNA DESTRA === #}
    <div class="col-lg-5">
        
        {# 1. ASSISTENTE GEMINI #}
        <div class="card shadow-sm mb-4 border-info">
            <div class="card-header bg-info text-white py-3">
                <h5 class="mb-0"><i class="bi bi-robot me-2"></i> {% translate "Assistente Gemini" %}</h5>
            </div>
            <div class="card-body text-center">
                 <button class="btn btn-outline-info btn-sm w-100 mb-2 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAI">
                    {% translate "Apri Assistente AI" %}
                </button>
                <div id="collapseAI" class="collapse">
                    <textarea class="form-control mb-2" id="ai-query-input" rows="3" placeholder="Chiedi supporto NIS2..."></textarea>
                    <button type="button" class="btn btn-sm btn-info w-100 text-white fw-bold" id="submit-ai-query">{% translate "Ottieni Risposta" %}</button>
                    <div class="mt-3 p-3 border rounded bg-white small text-start shadow-sm" id="ai-response-text" style="min-height: 60px;">
                        <span class="text-muted">{% translate "In attesa..." %}</span>
                    </div>
                </div>
            </div>
        </div>

        {# 2. CARD STRUMENTI OPERATIVA #}
        {% if request.user.ruolo == 'CONSULENTE' %}
<div class="card shadow-sm mb-4 border-start border-info border-4">
    <div class="card-header bg-light py-2">
        <h6 class="mb-0 fw-bold text-info text-uppercase small">
            <i class="bi bi-tools me-2"></i>{% translate "Strumenti di Controllo Tecnico" %}
        </h6>
    </div>
    <div class="card-body py-3">
        <div class="row g-3">
            
            <div class="col-12">
                <div class="p-2 border rounded bg-white shadow-sm">
                    <p class="small fw-bold text-secondary mb-2 border-bottom pb-1">
                        <i class="bi bi-shield-shaded me-1"></i> {% translate "Analisi Vulnerabilit√† (Nessus)" %}
                    </p>
                    <div class="d-flex gap-2">
                        <a href="{% url 'compliance:analisi_vulnerabilita_view' %}" class="btn btn-sm btn-outline-primary w-50 py-1" style="font-size: 0.75rem;">
                            <i class="bi bi-search"></i> {% translate "Vedi Scansioni" %}
                        </a>
                        <a href="{% url 'compliance:analisi_vulnerabilita_view' %}" class="btn btn-xs btn-outline-secondary w-50" style="font-size: 0.75rem;">
                    <i class="bi bi-file-text"></i> {% translate "Registro" %}
                </a>
            </div>
        </div>
    </div>
</div>
            
            {# Monitoraggio NIS2 #}
        <div class="col-12">
            <div class="p-2 border rounded bg-white shadow-sm">
                 <p class="small fw-bold text-secondary mb-2 border-bottom pb-1">
                <i class="bi bi-speedometer2 me-1"></i> {% translate "Monitoraggio & Log" %}
            </p>
            <div class="d-flex gap-2">
                {# LINK EVENTI #}
                <a href="{% url 'compliance:monitoraggio_eventi_view' %}" class="btn btn-xs btn-outline-info w-50" style="font-size: 0.75rem;">
                    <i class="bi bi-list-check"></i> {% translate "Log Eventi" %}
                </a>
                {# LINK ALERT #}
                <a href="{% url 'compliance:alert_configurazione' %}" class="btn btn-xs btn-outline-warning w-50" style="font-size: 0.75rem;">
                    <i class="bi bi-bell"></i> {% translate "Alert" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
        {# 3. REGISTRO NOTIFICHE #}
        <div class="card shadow-sm border-danger mb-4">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center" style="min-height: 55px;">
                <h5 class="mb-0 flex-grow-1">
                    <button class="btn btn-link text-white text-decoration-none shadow-none w-100 text-start p-0 fw-bold d-flex align-items-center" 
                            type="button" data-bs-toggle="collapse" data-bs-target="#collapseRegistro">
                        <i class="bi bi-chevron-right me-2"></i> {% translate "2. Registro Notifiche" %}
                    </button>
                </h5>
            </div>
            <div id="collapseRegistro" class="collapse">
                <div class="card-body">
                    <div class="d-grid mb-3">
                        <a href="{% url 'compliance:csirt_notifica_create' %}" class="btn btn-outline-danger btn-sm fw-bold">
                            <i class="bi bi-bell-fill me-2"></i> {% translate "Registra Nuova Notifica" %}
                        </a>
                    </div>
                    {% if notifiche %}
                        <ul class="list-group list-group-flush small">
                            {% for notifica in notifiche %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div class="ps-1">
                                        <h6 class="mb-0 fw-bold" style="font-size: 0.85rem;">{{ notifica.titolo_incidente|truncatechars:30 }}</h6>
                                        <span class="badge bg-secondary smaller">{{ notifica.get_stato_display }}</span>
                                    </div>
                                    <a href="{% url 'compliance:csirt_notifica_dettaglio' pk=notifica.pk %}" class="btn btn-sm btn-link text-info">{% translate "Vedi" %}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small text-center py-2">{% translate "Nessuna notifica registrata." %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# 4. GESTIONE RETE E UTILITY #}
        <div class="card shadow-sm mb-4 border-info">
            <div class="card-header bg-light py-2">
                 <span class="small fw-bold text-info">{% translate "Utility NIS2 & Asset" %}</span>
            </div>
            <div class="card-body p-2">
                 <a href="{% url 'compliance:configurazione_rete_view' %}" class="btn btn-sm btn-primary w-100 mb-2 shadow-sm">
                    <i class="bi bi-diagram-3-fill me-1"></i> {% translate "Gestisci Rete Informatica" %}
                </a>
                <div class="bg-light rounded p-2 small border text-center">
                    <span class="text-danger fw-bold">24h</span>: Early Warning | <span class="text-warning fw-bold">72h</span>: Notifica
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Applica classi Bootstrap ai campi del form
        document.querySelectorAll('#csirt-form input, #csirt-form select, #csirt-form textarea').forEach(el => {
            if (!el.classList.contains('form-check-input')) {
                el.classList.add('form-control');
                el.classList.add('form-control-sm');
            }
        });

        // Gestione icone dinamiche (Chevron Right -> Down)
        const setupChevron = (id) => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('show.bs.collapse', function () {
                    const trigger = document.querySelector(`[data-bs-target="#${id}"] i.bi`);
                    if(trigger) trigger.classList.replace('bi-chevron-right', 'bi-chevron-down');
                });
                el.addEventListener('hide.bs.collapse', function () {
                    const trigger = document.querySelector(`[data-bs-target="#${id}"] i.bi`);
                    if(trigger) trigger.classList.replace('bi-chevron-down', 'bi-chevron-right');
                });
            }
        };
        
        setupChevron('collapseDesignazione');
        setupChevron('collapseRegistro');

        // Logica AJAX Gemini
        $('#submit-ai-query').on('click', function() {
            const query = $('#ai-query-input').val();
            if (!query.trim()) return;
            const $btn = $(this);
            const $response = $('#ai-response-text');
            
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> ...');
            $response.html('<span class="text-muted italic">{% translate "Analisi in corso..." %}</span>');
            
            $.ajax({
                url: "{% url 'compliance:csirt_ai_query' %}",
                type: 'POST',
                data: JSON.stringify({ 'prompt': query }),
                contentType: 'application/json',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: (res) => $response.text(res.response),
                error: () => $response.html('<span class="text-danger">{% translate "Errore nel servizio AI." %}</span>'),
                complete: () => $btn.prop('disabled', false).text('{% translate "Ottieni Risposta" %}')
            });
        });
    });
</script>
{% endblock content %}